<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMBRE QR</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="flex items-center justify-center h-screen bg-gray-100">
    <div x-data="telegramBot()" x-init="getLocation" class="text-center">
        <button 
            x-bind:disabled="!locationGranted || locationSent" 
            @click="sendLocation" 
            class="px-8 py-4 bg-blue-500 text-white text-xl font-bold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
            Tocar Timbre
        </button>
        <template x-if="mediaRecorderSupported">
            <div>
                <button 
                    x-bind:disabled="!locationGranted || isRecording" 
                    @click="startRecording" 
                    class="px-8 py-4 bg-green-500 text-white text-xl font-bold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    Grabar Mensaje
                </button>
                <button 
                    x-show="isRecording" 
                    @click="stopRecording" 
                    class="px-8 py-4 bg-red-500 text-white text-xl font-bold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    Detener Grabación
                </button>
            </div>
        </template>
        <audio x-show="audioUrl" x-bind:src="audioUrl" controls class="mt-4"></audio>
        <p x-show="locationSent" class="mt-4 text-green-500">Notificación enviada</p>
        <p x-show="locationDenied" class="mt-4 text-red-500">Permisos de geolocalización no concedidos</p>
        <template x-if="countdown > 0">
            <p class="mt-4 text-gray-500" x-text="'Puedes presionar nuevamente en ' + countdown + ' segundos'"></p>
        </template>
    </div>

    <script>
        function telegramBot() {
            return {
                botToken: '7247263560:AAF6PpVlY9TbO5SpQHnzFGNu0D1HBbSPuhc',
                chatId: '-4286332749',
                latitude: null,
                longitude: null,
                locationGranted: false,
                locationSent: false,
                locationDenied: false,
                countdown: 0,
                isRecording: false,
                mediaRecorder: null,
                audioChunks: [],
                mediaRecorderSupported: false,
                audioUrl: '',
                getLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            this.latitude = position.coords.latitude;
                            this.longitude = position.coords.longitude;
                            this.locationGranted = true;
                            this.locationDenied = false;
                        }, error => {
                            console.error('Error al obtener la geolocalización:', error);
                            this.locationGranted = false;
                            this.locationDenied = true;
                        });
                    } else {
                        console.error('Geolocalización no soportada por este navegador.');
                        this.locationGranted = false;
                        this.locationDenied = true;
                    }

                    // Verificar compatibilidad de MediaRecorder
                    this.mediaRecorderSupported = 'MediaRecorder' in window;
                },
                startRecording() {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            this.mediaRecorder = new MediaRecorder(stream);
                            this.mediaRecorder.start();
                            this.isRecording = true;
                            this.audioChunks = [];
                            this.mediaRecorder.ondataavailable = event => {
                                this.audioChunks.push(event.data);
                            };
                        })
                        .catch(error => {
                            console.error('Error al acceder al micrófono:', error);
                        });
                },
                stopRecording() {
                    this.mediaRecorder.stop();
                    this.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/ogg; codecs=opus' });
                        const formData = new FormData();
                        formData.append('chat_id', this.chatId);
                        formData.append('voice', audioBlob);
                        fetch(`https://api.telegram.org/bot${this.botToken}/sendVoice`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.ok) {
                                this.locationSent = true;
                                this.countdown = 20;
                                const timer = setInterval(() => {
                                    this.countdown--;
                                    if (this.countdown <= 0) {
                                        clearInterval(timer);
                                    }
                                }, 1000);
                                setTimeout(() => {
                                    this.locationSent = false;
                                }, 20000); // 20 segundos

                                this.getAudioUrl(data.result.voice.file_id);
                            } else {
                                console.error('Error al enviar mensaje de voz');
                            }
                        })
                        .catch(error => {
                            console.error('Error al enviar mensaje de voz:', error);
                        });
                    };
                    this.isRecording = false;
                },
                getAudioUrl(file_id) {
                    fetch(`https://api.telegram.org/bot${this.botToken}/getFile?file_id=${file_id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.ok) {
                                const filePath = data.result.file_path;
                                this.audioUrl = `https://api.telegram.org/file/bot${this.botToken}/${filePath}`;
                            } else {
                                console.error('Error al obtener la URL del archivo');
                            }
                        })
                        .catch(error => {
                            console.error('Error al obtener la URL del archivo:', error);
                        });
                },
                sendLocation() {
                    if (this.locationGranted) {
                        const now = new Date();
                        const date = `${now.getFullYear()}-${('0' + (now.getMonth() + 1)).slice(-2)}-${('0' + now.getDate()).slice(-2)}`;
                        const time = `${('0' + now.getHours()).slice(-2)}:${('0' + now.getMinutes()).slice(-2)}:${('0' + now.getSeconds()).slice(-2)}`;
                        
                        fetch(`https://api.telegram.org/bot${this.botToken}/sendLocation`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                chat_id: this.chatId,
                                latitude: this.latitude,
                                longitude: this.longitude,
                                caption: `Ubicación enviada el ${date} a las ${time}`
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.ok) {
                                this.locationSent = true;
                                this.countdown = 20;
                                const timer = setInterval(() => {
                                    this.countdown--;
                                    if (this.countdown <= 0) {
                                        clearInterval(timer);
                                    }
                                }, 1000);
                                setTimeout(() => {
                                    this.locationSent = false;
                                }, 20000); // 20 segundos
                            } else {
                                console.error('Error al enviar ubicación');
                            }
                        })
                        .catch(error => {
                            console.error('Error al enviar ubicación:', error);
                        });
                    } else {
                        console.error('Permisos de geolocalización no concedidos.');
                    }
                }
            };
        }
    </script>
</body>
</html>
