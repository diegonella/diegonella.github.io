<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMBRE QR</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.error('Error al registrar Service Worker:', error);
                    });
            });
        }
    </script>
    
</head>
<body class="flex items-center justify-center h-screen bg-gray-100">
    <div x-data="telegramBot()" x-init="getLocation" class="text-center">
        <button 
            x-bind:disabled="!locationGranted || locationSent" 
            @click="sendLocation" 
            class="px-8 py-4 bg-blue-500 text-white text-xl font-bold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
            Tocar Timbre
        </button>
        <p x-show="locationSent" class="mt-4 text-green-500">Notificación enviada</p>
        <p x-show="locationDenied" class="mt-4 text-red-500">Permisos de geolocalización no concedidos</p>
        <template x-if="countdown > 0">
            <p class="mt-4 text-gray-500" x-text="'Puedes presionar nuevamente en ' + countdown + ' segundos'"></p>
        </template>
    </div>

    <script>
        function telegramBot() {
            return {
                botToken: '7247263560:AAF6PpVlY9TbO5SpQHnzFGNu0D1HBbSPuhc',
                chatId: '-4286332749',
                latitude: null,
                longitude: null,
                locationGranted: false,
                locationSent: false,
                locationDenied: false,
                countdown: 0,
                getLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            this.latitude = position.coords.latitude;
                            this.longitude = position.coords.longitude;
                            this.locationGranted = true;
                            this.locationDenied = false;
                        }, error => {
                            console.error('Error al obtener la geolocalización:', error);
                            this.locationGranted = false;
                            this.locationDenied = true;
                        });
                    } else {
                        console.error('Geolocalización no soportada por este navegador.');
                        this.locationGranted = false;
                        this.locationDenied = true;
                    }
                },
                sendLocation() {
                    if (this.locationGranted) {
                        const now = new Date();
                        const date = `${now.getFullYear()}-${('0' + (now.getMonth() + 1)).slice(-2)}-${('0' + now.getDate()).slice(-2)}`;
                        const time = `${('0' + now.getHours()).slice(-2)}:${('0' + now.getMinutes()).slice(-2)}:${('0' + now.getSeconds()).slice(-2)}`;
                        
                        fetch(`https://api.telegram.org/bot${this.botToken}/sendLocation`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                chat_id: this.chatId,
                                latitude: this.latitude,
                                longitude: this.longitude,
                                caption: `Ubicación enviada el ${date} a las ${time}`
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.ok) {
                                this.locationSent = true;
                                this.countdown = 20;
                                const timer = setInterval(() => {
                                    this.countdown--;
                                    if (this.countdown <= 0) {
                                        clearInterval(timer);
                                    }
                                }, 1000);
                                setTimeout(() => {
                                    this.locationSent = false;
                                }, 20000); // 20 segundos
                            } else {
                                console.error('Error al enviar ubicación');
                            }
                        })
                        .catch(error => {
                            console.error('Error al enviar ubicación:', error);
                        });
                    } else {
                        console.error('Permisos de geolocalización no concedidos.');
                    }
                }
            };
        }
    </script>
</body>
</html>
